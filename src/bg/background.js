// Generated by CoffeeScript 1.7.1
(function() {
  var service,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  this.Service = (function() {
    function Service() {
      this.openAndReceive = __bind(this.openAndReceive, this);
      this.open = __bind(this.open, this);
      this.getLastStatus = __bind(this.getLastStatus, this);
      this.on = __bind(this.on, this);
      this.checkMail = __bind(this.checkMail, this);
      this.periodInMinutes = 1000 * 60 * 5;
      this.events = {
        received: function(status) {
          return console.log(status);
        }
      };
      this.cb = new Cybozu();
      this.checker = new MailChecker(this.cb.getChckerUrl());
      this.status = new BadgeStatus();
      this.loading = new LoadingAnimation();
    }

    Service.prototype.checkMail = function() {
      console.log("check email");
      this.loading.start();
      return this.checker.check().then((function(_this) {
        return function(status) {
          _this.status.update(status);
          _this.events.received(status);
          return _this.loading.stop();
        };
      })(this));
    };

    Service.prototype.start = function() {
      console.log("start", this);
      this.checkMail();
      this.cb.pageUpdated((function(_this) {
        return function() {
          return _this.checkMail();
        };
      })(this));
      return window.setInterval(this.checkMail, this.periodInMinutes);
    };

    Service.prototype.on = function(key, func) {
      return this.events[key] = func;
    };

    Service.prototype.getLastStatus = function() {
      return this.checker.getLastStatus();
    };

    Service.prototype.open = function() {
      console.log("open");
      return this.cb.openPage();
    };

    Service.prototype.openAndReceive = function() {
      console.log("openAndReceive");
      return this.cb.openPageAndMailCheck();
    };

    return Service;

  })();

  (service = new Service()).start();

  (function(global) {
    return global.getService = function() {
      return service;
    };
  })(this);

}).call(this);
